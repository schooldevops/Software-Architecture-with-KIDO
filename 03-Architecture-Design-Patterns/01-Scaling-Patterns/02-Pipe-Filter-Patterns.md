# Pipes and Filters Patterns

## 개요

- Pipes and Filters Pattern은 데이터 처리를 여러 단계로 나누고, 각 단계를 처리하는 필터를 구성하여 데이터를 처리하는 패턴
- 데이터는 각 필터를 통과하며 필터에서는 입력 데이터를 가공하고 출력 데이터를 다음 필터에 전달

- 대표적인 예시로는 Unix 운영체제에서 사용되는 파이프라인이 있다. 
  - 예를 들어, cat 명령어로 파일의 내용을 출력하고, 이를 grep 명령어로 필터링하고, 다시 sort 명령어로 정렬하여 출력하는 과정에서 파이프라인이 사용된다.
- 또한 다른 예로, 데이터 추출, 전처리, 분석, 저장 등의 과정으로 이루어진 데이터 처리 시스템에서, 이를 Pipes and Filters Pattern으로 구현하면, 데이터 추출 필터, 전처리 필터, 분석 필터, 저장 필터로 나누어 각 단계를 처리하고, 필요한 경우 필터를 추가, 제거, 변경하여 데이터 처리 시스템을 유연하게 변경할 수 있다.
- 
![pipe-filter-01](imgs/pipes-and-filters-solution.png)

- 위 예제는 서로다른 메시지 파이프라인으로 부터 메시지를 받고, 파이프/필터를 거쳐 최종 비즈니쇼 로직을 완료한다. 
- 즉 파이프/필터 구조(토폴로지)를 구성하고 나면 다양한 소스로 재 사용이 가능하다. 
  
![pipe-filter-02](imgs/pipes-and-filters-load-balancing.png)

- 단일 필터를 통해서 작업을 처리하는 경우, 메시지의 양이 늘어나면 큐에 적재되고, 
- 적재량대비 처리량이 떨어질 수 있음 
- 이 경우 동일한 Task 인스턴스를 증가하여, 메시지를 병렬로 처리하고 이를 취합할 수 있다. 

![pipe-filter-03](imgs/pipes-and-filters-message-queues.png)

- 전형적인 메시지 큐를 활용한 파이프앤 필터 패턴
- 메시지 큐는 파이프에 해당
- 필터는 컨슈머가 되며 다시 프로듀서 역할을 하게 된다.

## 베스트프랙티스 

- 모듈성
  - 각 필터는 입력 데이터와 출력 데이터를 정의하여 독립적으로 작동하므로, 모듈성이 높아져서 유지 보수 및 확장성이 용이하다.
  - 필터의 수를 늘이면, 성능역시 향상 가능 

- 재사용성
  - 필터는 단일 책임을 가지므로, 재사용이 가능하고, 각 필터의 조합으로 새로운 데이터 처리 기능을 만들 수 있다.
  - 필터와 파이프 토폴로지 구성에 다라 다양한 기능을 할 수 있다. 

- 유연성
  - 필터는 각 단계마다 데이터를 가공하여 출력하므로, 각 단계의 구현 방식을 자유롭게 선택할 수 있다.

- 성능 
  - Pipes and Filters Pattern은 다수의 작은 단위의 필터를 통해 데이터를 처리하기 때문에, 대용량 데이터 처리에도 높은 성능을 보장

- 테스트 용이성
  - 각 단계의 입력과 출력이 정의되어 있으므로, 단위 테스트를 쉽게 구성할 수 있다.

## 고려사항

- 복잡도
  - 유연성이 높아지는 반면, 복잡도는 올라간다. 
  - 각 파이프/필터들을 유지하고 관리가 쉽지 않다. 
- 신뢰성
  - 파이프/필터를 거쳐갈때 데이터 유실이 발생하지 않도록 신중을 기해야한다. 
- 멱등성
  - 중복되는 데이터(메시지)가 들어와도 동일한 결과가 될수 있도록 멱등성을 지키도록 해야한다. 
  - 중복이 들어오면 처리 상태에 다라 무시 혹은 재처리후 최종 일관성을 지킬 수 있도록 고려
- 중목 메시지
  - 메시지가 중복되는 경우 발생
  - 메시지의 중복으로 결과가 달라지지 않도록 고려해야한다.

## WrapUp

- Pipe and Filter 패턴은 전형적인 메시지 스트림 시스템에서 주로 사용
- Pipe는 메시지 큐 등으로 구현
- Filter는 독립적이면서도 멱등성을 유지하여 중복데이터 혹은 메시지 유실이 없도록 개발이 되어야한다. 
- 유연성이 극대화 되며, 반대로 복잡도는 올라가므로, 적절한 단위의 아키텍처 설계가 필요

## 참고: 

- https://learn.microsoft.com/en-us/azure/architecture/patterns/pipes-and-filters
